<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Renewal Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Figma Design Tokens - Primary Blues
                        'ctct-blue': '#1856ed',
                        'ctct-blue-dark': '#1330bf',
                        'ctct-sapphire': '#12277d',
                        'ctct-sky': '#a6daff',
                        'ctct-arctic': '#d9f2ff',
                        'ctct-poolside': '#84dfff',
                        
                        // Figma Design Tokens - Neutrals
                        'ctct-gray': '#5d687e',
                        'ctct-light': '#f7f9fd',
                        'ctct-border': '#dce2ec',
                        'ctct-overcast': '#edf1f8',
                        'ctct-chinchilla': '#c9d0de',
                        'ctct-shadow': '#0f141c',
                        'ctct-dark': '#313b4d',
                        
                        // Figma Design Tokens - Alert/Success Colors
                        'ctct-warning': '#f79009',
                        'ctct-warning-bg': '#fff2de',
                        'ctct-orange': '#f79009',
                    }
                }
            }
        }
    </script>
    <style>
        /* Payment method selection */
        .payment-option input[type="radio"]:checked + label {
            border-color: #1856ed;
            background-color: #f7f9fd;
        }
        
        /* Custom radio button styling */
        .billing-option input[type="radio"]:checked + span {
            background-color: white;
            border-color: #1856ed !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-ctct-light min-h-screen flex flex-col">
    
    <!-- Header -->
    <header class="bg-ctct-blue px-4 sm:px-6 lg:px-8 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center">
                <img src="ctct-logo-white.png" alt="Constant Contact" class="h-8 w-auto">
            </div>
            
            <!-- Close Button -->
            <button class="text-white hover:text-white/80 transition-colors p-2" aria-label="Close">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Progress Stepper -->
    <div class="bg-white border-b border-ctct-border">
        <div class="max-w-3xl mx-auto px-4 py-6">
            <div class="flex items-center">
                <!-- Step 1: Select plan (completed - clickable) -->
                <div class="flex flex-col items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity" id="step-select-plan">
                    <div class="w-5 h-5 rounded-full bg-ctct-blue flex items-center justify-center flex-shrink-0">
                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <span class="text-sm font-medium text-gray-500 whitespace-nowrap">Select plan</span>
                </div>
                
                <!-- Connector (completed) -->
                <div class="flex-1 h-px bg-ctct-blue mx-4 -mt-6"></div>
                
                <!-- Step 2: Add-ons (completed - clickable) -->
                <div class="flex flex-col items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity" id="step-addons">
                    <div class="w-5 h-5 rounded-full bg-ctct-blue flex items-center justify-center flex-shrink-0">
                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <span class="text-sm font-medium text-gray-500 whitespace-nowrap">Add-ons</span>
                </div>
                
                <!-- Connector (completed) -->
                <div class="flex-1 h-px bg-ctct-blue mx-4 -mt-6"></div>
                
                <!-- Step 3: Checkout (active) -->
                <div class="flex flex-col items-center gap-2">
                    <div class="w-5 h-5 rounded-full border-2 border-ctct-blue bg-white flex items-center justify-center flex-shrink-0">
                        <div class="w-2 h-2 rounded-full bg-ctct-blue"></div>
                    </div>
                    <span class="text-sm font-semibold text-gray-900 whitespace-nowrap">Checkout</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        <div class="max-w-6xl mx-auto">
            
            <!-- Prepay and Nonprofit Discounts Section -->
            <div class="bg-white rounded-xl p-4 sm:p-6 mb-6 shadow-sm border border-ctct-border">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900">Prepay and nonprofit discounts</h2>
                    <button class="text-ctct-blue hover:text-ctct-blue-dark p-1" aria-label="Learn more">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="flex flex-col lg:flex-row lg:items-center gap-4">
                    <!-- Billing Period Options -->
                    <div class="w-full lg:flex-1 flex flex-wrap items-stretch gap-2 sm:gap-1 sm:flex sm:rounded-lg sm:border sm:border-ctct-border sm:p-1 bg-ctct-light sm:bg-white">
                        <!-- Monthly (Disabled - can't downgrade from prepay) -->
                        <label class="billing-option flex-1 flex opacity-60">
                            <input type="radio" name="billing" value="monthly" class="sr-only" disabled>
                            <span class="flex flex-col justify-center w-full px-4 sm:px-6 py-3 rounded-lg sm:rounded-md text-center cursor-not-allowed border-2 border-transparent bg-ctct-light transition-all">
                                <span class="block text-sm font-medium text-ctct-gray">Monthly</span>
                            </span>
                        </label>
                        
                        <!-- Prepay 6 months (Disabled - can't downgrade from 12 months) -->
                        <label class="billing-option flex-1 flex opacity-60">
                            <input type="radio" name="billing" value="6months" class="sr-only" disabled>
                            <span class="flex flex-col justify-center w-full px-4 sm:px-6 py-3 rounded-lg sm:rounded-md text-center cursor-not-allowed border-2 border-transparent bg-ctct-light transition-all">
                                <span class="block text-sm font-medium text-ctct-gray">Prepay 6 months</span>
                                <span class="block text-xs text-ctct-gray font-medium">SAVE 10%</span>
                            </span>
                        </label>
                        
                        <!-- Prepay 12 months (Selected) -->
                        <label class="billing-option flex-1 flex">
                            <input type="radio" name="billing" value="12months" class="sr-only" checked>
                            <span class="flex flex-col justify-center w-full px-4 sm:px-6 py-3 rounded-lg sm:rounded-md text-center cursor-pointer border-2 border-ctct-border sm:border-transparent bg-white sm:bg-transparent transition-all">
                                <span class="block text-sm font-medium text-gray-900">Prepay 12 months</span>
                                <span class="block text-xs text-green-600 font-medium">SAVE 15%</span>
                                <span class="block text-xs text-ctct-gray">Current</span>
                            </span>
                        </label>
                    </div>
                    
                    <!-- Nonprofit Toggle -->
                    <div class="flex items-center gap-3 flex-shrink-0">
                        <span class="text-sm text-gray-700">Nonprofit?</span>
                        <button type="button" role="switch" aria-checked="false" class="nonprofit-toggle relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gray-200 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-ctct-blue focus:ring-offset-2">
                            <span class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                        </button>
                    </div>
                </div>
                
                <!-- Prominent Alert Banner for Payment Term Notice -->
                <div class="mt-4 flex items-center gap-3 bg-ctct-warning-bg border border-ctct-warning/30 rounded-lg px-4 py-3">
                    <div class="flex-shrink-0">
                        <svg class="w-5 h-5 text-ctct-warning" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <p class="text-sm text-gray-800">You can shorten your payment term up to 30 days before 02/10/2026.</p>
                </div>
            </div>

            <!-- Two Column Layout -->
            <div class="flex flex-col lg:flex-row gap-6 lg:items-stretch">
                
                <!-- Left Column - Payment & Billing -->
                <div class="flex-1 flex flex-col gap-6">
                    
                    <!-- Payment Method -->
                    <div class="bg-white rounded-xl p-6 border border-ctct-border">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment method</h3>
                        
                        <!-- Payment Options -->
                        <div class="flex gap-2 mb-4">
                            <label class="payment-option flex-1">
                                <input type="radio" name="payment" value="card" class="sr-only" checked>
                                <label class="block p-3 border-2 border-ctct-blue bg-ctct-light rounded-lg cursor-pointer">
                                    <svg class="w-5 h-5 text-ctct-blue mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                    </svg>
                                    <span class="text-sm font-medium text-ctct-blue">Card</span>
                                </label>
                            </label>
                            
                            <label class="payment-option flex-1">
                                <input type="radio" name="payment" value="paypal" class="sr-only">
                                <label class="block p-3 border border-ctct-border rounded-lg cursor-pointer hover:border-ctct-blue transition-colors">
                                    <svg class="w-5 h-5 text-gray-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                    </svg>
                                    <span class="text-sm text-gray-700">Paypal</span>
                                </label>
                            </label>
                            
                            <label class="payment-option flex-1">
                                <input type="radio" name="payment" value="bank" class="sr-only">
                                <label class="block p-3 border border-ctct-border rounded-lg cursor-pointer hover:border-ctct-blue transition-colors">
                                    <svg class="w-5 h-5 text-gray-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                    </svg>
                                    <span class="text-sm text-gray-700">Us bank account</span>
                                </label>
                            </label>
                            
                            <button class="p-3 border border-ctct-border rounded-lg hover:border-ctct-blue transition-colors">
                                <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                    <circle cx="6" cy="12" r="2"/>
                                    <circle cx="12" cy="12" r="2"/>
                                    <circle cx="18" cy="12" r="2"/>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Edit Link -->
                        <div class="text-right mb-4">
                            <a href="#" class="text-sm text-ctct-blue hover:text-ctct-blue-dark font-medium">Edit</a>
                        </div>
                        
                        <!-- Saved Card -->
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-700">American Express ending in **** ******** *<span class="font-semibold">8431</span></p>
                                <p class="text-sm text-ctct-gray">Expires 10/2029</p>
                            </div>
                            <div class="bg-[#006FCF] text-white text-xs font-bold px-2 py-1 rounded">AMEX</div>
                        </div>
                    </div>
                    
                    <!-- Billing Information -->
                    <div class="bg-white rounded-xl p-6 border border-ctct-border flex-1">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Billing information</h3>
                            <a href="#" class="text-sm text-ctct-blue hover:text-ctct-blue-dark font-medium">Edit</a>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <!-- Address -->
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-1">Address:</p>
                                <p class="text-sm text-gray-900">Alexander Christopher</p>
                                <p class="text-sm text-gray-900">Alphabet Inc.</p>
                                <p class="text-sm text-gray-900">1600 Amphitheatre Parkway</p>
                                <p class="text-sm text-gray-900">Mountain View, CA</p>
                                <p class="text-sm text-gray-900">94043</p>
                                <p class="text-sm text-gray-900">United States</p>
                            </div>
                            
                            <!-- Phone & Email -->
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-1">Phone number:</p>
                                <p class="text-sm text-gray-900 mb-4">737 888 1234</p>
                                
                                <p class="text-sm font-medium text-gray-700 mb-1">Billing email:</p>
                                <p class="text-sm text-gray-900 break-all">alexander.christopher@billingaddress.com</p>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Right Column - Order Summary -->
                <div class="lg:w-96 flex-shrink-0">
                    <div class="bg-white rounded-xl p-6 border border-ctct-border">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Order summary</h3>
                        
                        <!-- Plan Charge -->
                        <div class="mb-4 pb-4 border-b border-ctct-border" id="plan-charge-section">
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-semibold text-gray-900">Prorated plan charge</span>
                                <span class="text-sm font-semibold text-gray-900" id="plan-total">$816.00</span>
                            </div>
                            <p class="text-xs text-ctct-gray">Premium (Contacts 500 - 1,000)</p>
                            <p class="text-xs text-ctct-gray" id="plan-term-detail">Prepay 12 months ($68/mo × 12 mo)</p>
                            <div class="flex justify-between mt-1" id="plan-discount-row">
                                <a href="#" class="text-xs text-green-600 hover:underline">Prepay savings <span id="plan-discount-percent">15%</span> discount</a>
                                <span class="text-xs text-green-600" id="plan-discount-amount">-$122.40</span>
                            </div>
                            <a href="plan-selection-renewal.html" class="text-xs text-ctct-blue hover:underline">Edit plan</a>
                        </div>
                        
                        <!-- Dynamic Add-ons Container -->
                        <div id="addons-container">
                            <!-- Add-ons will be dynamically inserted here -->
                        </div>
                        
                        <!-- Discount Code -->
                        <div class="mb-4 pb-4 border-b border-ctct-border">
                            <p class="text-sm text-gray-700 mb-2">Have a discount code?</p>
                            <div class="flex gap-2">
                                <input type="text" placeholder="Discount code" class="flex-1 px-3 py-2 border border-ctct-border rounded-lg text-sm focus:outline-none focus:border-ctct-blue">
                                <button class="px-4 py-2 border border-ctct-border rounded-lg text-sm text-ctct-gray hover:border-ctct-blue hover:text-ctct-blue transition-colors">
                                    Apply
                                </button>
                            </div>
                        </div>
                        
                        <!-- Totals -->
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-700">Subtotal before tax</span>
                                <span class="text-sm text-gray-900" id="subtotal-amount">$908.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-green-600 font-medium">Total savings</span>
                                <span class="text-sm text-green-600 font-medium" id="total-savings">–$137.70</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-700">Tax</span>
                                <span class="text-sm text-gray-900" id="tax-amount">$ 9.08</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-ctct-border">
                                <span class="text-sm font-semibold text-gray-900">Today's total</span>
                                <span class="text-sm font-semibold text-gray-900" id="today-total">$779.38</span>
                            </div>
                        </div>
                        
                        <!-- Legal Text -->
                        <div class="text-xs text-ctct-gray mb-4 space-y-3">
                            <p>
                                Auto renewal terms: All subscriptions automatically renew monthly, at the then current list price (plus applicable taxes), after your 14 day Free Trial, using the payment method on file, unless cancelled prior to your next bill date. Your monthly bill may increase depending on your highest contact list size and email and SMS sends. Overage Fees may apply. <a href="#" class="text-ctct-blue hover:underline">See overage fees & current contact tier pricing</a>. You may cancel at any time from your account or by calling 855-229-5506.
                            </p>
                            <p>
                                By submitting your payment you acknowledge that you have read and agree to our prepayment terms, the <a href="#" class="text-ctct-blue hover:underline">Terms of Service</a> and <a href="#" class="text-ctct-blue hover:underline">Privacy Notice</a>.
                            </p>
                        </div>
                        
                        <!-- Pay Button -->
                        <button id="pay-button" class="w-full py-3 px-4 rounded-full bg-ctct-orange text-gray-900 font-semibold hover:bg-orange-500 transition-colors flex items-center justify-center gap-2 mb-4">
                            <svg id="lock-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                            <span id="pay-button-text">Pay 779.38 now</span>
                        </button>
                        
                        <!-- Payment Icons -->
                        <div class="flex items-center justify-center">
                            <img src="payment-icons.png" alt="Visa, Mastercard, American Express, Discover, PayPal" class="h-4 w-auto">
                        </div>
                    </div>
                </div>
                
            </div>
            
        </div>
    </main>
    <!-- JavaScript for Interactivity -->
    <script>
        // ============================================
        // Add-on Configuration and Pricing
        // ============================================
        
        // Default add-on configuration (will be overridden by localStorage if available)
        const defaultAddonsConfig = {
            'SMS Marketing': {
                id: 'sms',
                monthlyPrice: 10,
                description: '0 – 500 SMS/month',
                displayName: '0 – 500 SMS/mo',
                unit: 'SMS/mo'
            },
            'Inbox Preview': {
                id: 'inbox-preview',
                monthlyPrice: 45,
                description: '25 previews/month',
                displayName: '25 previews/mo',
                unit: 'previews/mo'
            },
            'Xero Accounting': {
                id: 'xero',
                monthlyPrice: 0,
                description: '6 months free',
                displayName: 'Xero Accounting',
                unit: ''
            }
        };

        // Billing term configuration
        const billingTerms = {
            'monthly': { months: 1, discount: 0, label: 'Monthly' },
            '6months': { months: 6, discount: 0.10, label: 'Prepay 6 months' },
            '12months': { months: 12, discount: 0.15, label: 'Prepay 12 months' }
        };

        // Plan base pricing
        const planConfig = {
            monthlyPrice: 68,
            name: 'Premium (Contacts 500 - 1,000)'
        };

        // Tax rate (1% for demo)
        const TAX_RATE = 0.01;

        // Get selected billing term
        function getSelectedBillingTerm() {
            const selected = document.querySelector('input[name="billing"]:checked');
            return selected ? selected.value : '12months';
        }

        // Get add-ons config from localStorage or use default
        function getAddonsConfig() {
            const stored = localStorage.getItem('addonsConfig');
            console.log('Retrieved addonsConfig from localStorage:', stored);
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('Error parsing addonsConfig:', e);
                    return defaultAddonsConfig;
                }
            }
            return defaultAddonsConfig;
        }

        // Get selected add-ons from localStorage
        function getSelectedAddons() {
            const stored = localStorage.getItem('selectedAddons');
            console.log('Retrieved selectedAddons from localStorage:', stored);
            let addons = {};
            
            if (stored) {
                try {
                    let parsed = JSON.parse(stored);
                    
                    // Ensure we have a plain object, not an array (arrays lose properties on JSON.stringify)
                    if (Array.isArray(parsed) || typeof parsed !== 'object' || parsed === null) {
                        console.log('Converting invalid stored value to object');
                        parsed = {};
                    }
                    
                    addons = parsed;
                } catch (e) {
                    console.error('Error parsing selectedAddons:', e);
                }
            }
            
            // SMS Marketing is always pre-purchased - ensure it's always included
            addons['SMS Marketing'] = true;
            
            console.log('Final selectedAddons:', addons);
            return addons;
        }

        // Format currency
        function formatCurrency(amount) {
            return '$' + amount.toFixed(2);
        }

        // Calculate add-on price based on billing term
        function calculateAddonPrice(monthlyPrice, billingTerm) {
            const term = billingTerms[billingTerm];
            const basePrice = monthlyPrice * term.months;
            const discount = basePrice * term.discount;
            return {
                basePrice: basePrice,
                discount: discount,
                finalPrice: basePrice - discount
            };
        }

        // Calculate plan price based on billing term
        function calculatePlanPrice(billingTerm) {
            const term = billingTerms[billingTerm];
            const basePrice = planConfig.monthlyPrice * term.months;
            const discount = basePrice * term.discount;
            return {
                basePrice: basePrice,
                discount: discount,
                finalPrice: basePrice - discount
            };
        }

        // Render single add-on item
        function renderAddonItem(addonName, config, billingTerm) {
            const term = billingTerms[billingTerm];
            const pricing = calculateAddonPrice(config.monthlyPrice, billingTerm);
            
            // Skip free add-ons in the price display (but show them)
            const isFree = config.monthlyPrice === 0;
            
            let html = `
                <div class="mb-4 pb-4 border-b border-ctct-border addon-item" data-addon="${config.id}" data-addon-name="${addonName}">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-semibold text-gray-900">${config.displayName || addonName}</span>
                        <span class="text-sm font-semibold text-gray-900">${isFree ? 'Free' : formatCurrency(pricing.basePrice)}</span>
                    </div>
            `;
            
            if (!isFree) {
                html += `<p class="text-xs text-ctct-gray">${term.label} ($${config.monthlyPrice}/mo × ${term.months} mo)</p>`;
                
                if (pricing.discount > 0) {
                    html += `
                        <div class="flex justify-between mt-1">
                            <a href="#" class="text-xs text-green-600 hover:underline">Prepay savings ${Math.round(term.discount * 100)}% discount</a>
                            <span class="text-xs text-green-600">-${formatCurrency(pricing.discount)}</span>
                        </div>
                    `;
                }
            } else {
                html += `<p class="text-xs text-ctct-gray">${config.description}</p>`;
            }
            
            html += `<div class="flex gap-3 mt-1">
                    <a href="addons-renewal.html" class="text-xs text-ctct-blue hover:underline">Edit add-on</a>
                    <a href="#" class="text-xs text-ctct-blue hover:underline remove-addon-link" data-addon-name="${addonName}">Remove</a>
                </div>
                </div>
            `;
            
            return html;
        }
        
        // Remove add-on handler
        function removeAddon(addonName) {
            const selectedAddons = getSelectedAddons();
            delete selectedAddons[addonName];
            localStorage.setItem('selectedAddons', JSON.stringify(selectedAddons));
            console.log('Removed addon:', addonName);
            
            // Re-render the order summary
            initializeOrderSummary();
        }
        
        // Attach remove handlers after rendering
        function attachRemoveHandlers() {
            document.querySelectorAll('.remove-addon-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const addonName = this.getAttribute('data-addon-name');
                    if (addonName) {
                        removeAddon(addonName);
                    }
                });
            });
        }

        // Render all add-ons
        function renderAddons() {
            const container = document.getElementById('addons-container');
            if (!container) {
                console.error('addons-container not found!');
                return;
            }
            
            const selectedAddons = getSelectedAddons();
            const addonsConfig = getAddonsConfig();
            const billingTerm = getSelectedBillingTerm();
            
            console.log('Rendering addons:', { selectedAddons, addonsConfig, billingTerm });
            
            let html = '';
            
            for (const [addonName, isSelected] of Object.entries(selectedAddons)) {
                console.log('Processing addon:', addonName, 'isSelected:', isSelected, 'hasConfig:', !!addonsConfig[addonName]);
                if (isSelected && addonsConfig[addonName]) {
                    html += renderAddonItem(addonName, addonsConfig[addonName], billingTerm);
                }
            }
            
            console.log('Generated HTML for addons:', html.length > 0 ? 'Has content' : 'Empty');
            container.innerHTML = html;
            
            // Attach click handlers for remove links
            attachRemoveHandlers();
        }

        // Update plan section based on billing term
        function updatePlanSection() {
            const billingTerm = getSelectedBillingTerm();
            const term = billingTerms[billingTerm];
            const pricing = calculatePlanPrice(billingTerm);
            
            document.getElementById('plan-total').textContent = formatCurrency(pricing.basePrice);
            document.getElementById('plan-term-detail').textContent = 
                `${term.label} ($${planConfig.monthlyPrice}/mo × ${term.months} mo)`;
            
            const discountRow = document.getElementById('plan-discount-row');
            if (pricing.discount > 0) {
                discountRow.style.display = 'flex';
                document.getElementById('plan-discount-percent').textContent = Math.round(term.discount * 100) + '%';
                document.getElementById('plan-discount-amount').textContent = '-' + formatCurrency(pricing.discount);
            } else {
                discountRow.style.display = 'none';
            }
        }

        // Calculate and update totals
        function updateTotals() {
            const selectedAddons = getSelectedAddons();
            const addonsConfig = getAddonsConfig();
            const billingTerm = getSelectedBillingTerm();
            
            // Calculate plan totals
            const planPricing = calculatePlanPrice(billingTerm);
            let subtotal = planPricing.basePrice;
            let totalDiscount = planPricing.discount;
            
            // Calculate add-ons totals
            for (const [addonName, isSelected] of Object.entries(selectedAddons)) {
                if (isSelected && addonsConfig[addonName]) {
                    const config = addonsConfig[addonName];
                    const pricing = calculateAddonPrice(config.monthlyPrice, billingTerm);
                    subtotal += pricing.basePrice;
                    totalDiscount += pricing.discount;
                }
            }
            
            const afterDiscount = subtotal - totalDiscount;
            const tax = afterDiscount * TAX_RATE;
            const total = afterDiscount + tax;
            
            // Update DOM
            document.getElementById('subtotal-amount').textContent = formatCurrency(subtotal);
            document.getElementById('total-savings').textContent = totalDiscount > 0 ? '–' + formatCurrency(totalDiscount) : '$0.00';
            document.getElementById('tax-amount').textContent = formatCurrency(tax);
            document.getElementById('today-total').textContent = formatCurrency(total);
            
            // Update pay button
            document.getElementById('pay-button-text').textContent = `Pay ${formatCurrency(total)} now`;
        }

        // Initialize the order summary
        function initializeOrderSummary() {
            updatePlanSection();
            renderAddons();
            updateTotals();
        }

        // ============================================
        // Event Handlers
        // ============================================

        // Nonprofit toggle
        document.querySelector('.nonprofit-toggle')?.addEventListener('click', function() {
            const isChecked = this.getAttribute('aria-checked') === 'true';
            this.setAttribute('aria-checked', !isChecked);
            
            const toggle = this.querySelector('span');
            if (!isChecked) {
                this.classList.remove('bg-gray-200');
                this.classList.add('bg-ctct-blue');
                toggle.classList.remove('translate-x-0');
                toggle.classList.add('translate-x-5');
            } else {
                this.classList.remove('bg-ctct-blue');
                this.classList.add('bg-gray-200');
                toggle.classList.remove('translate-x-5');
                toggle.classList.add('translate-x-0');
            }
        });

        // Billing term change - recalculate everything
        document.querySelectorAll('input[name="billing"]').forEach(radio => {
            radio.addEventListener('change', function() {
                console.log('Billing term changed to:', this.value);
                initializeOrderSummary();
            });
        });

        // Payment method selection
        document.querySelectorAll('.payment-option input').forEach(radio => {
            radio.addEventListener('change', function() {
                console.log('Selected payment method:', this.value);
            });
        });

        // Pay button handler with loading state
        document.getElementById('pay-button')?.addEventListener('click', function() {
            const button = this;
            const lockIcon = document.getElementById('lock-icon');
            const buttonText = document.getElementById('pay-button-text');
            
            // Disable button and show loading state
            button.disabled = true;
            button.classList.add('cursor-not-allowed', 'opacity-90');
            
            // Replace lock icon with spinner
            lockIcon.outerHTML = `<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>`;
            
            // Change button text
            buttonText.textContent = 'Processing...';
            
            console.log('Processing payment...');
            
            // After 2 seconds, navigate to confirmation page
            setTimeout(function() {
                window.location.href = 'confirmation-renewal.html';
            }, 2000);
        });

        // Progress stepper navigation
        document.getElementById('step-select-plan')?.addEventListener('click', function() {
            window.location.href = 'plan-selection-renewal.html';
        });

        document.getElementById('step-addons')?.addEventListener('click', function() {
            window.location.href = 'addons-renewal.html';
        });

        // ============================================
        // Initialize on page load
        // ============================================
        document.addEventListener('DOMContentLoaded', initializeOrderSummary);
        
        // Also initialize immediately in case DOM is already ready
        if (document.readyState !== 'loading') {
            initializeOrderSummary();
        }
    </script>
</body>
</html>
